for (S in (1:Smax)) {#
	for(p in 1:(3)) {#
		        S_g <- S #
		        MTcosts[p, S] <-  coef2*S_g^theta*exp(-E/(k*Temp[p]))   #
    }#
  }
matplot( ((1:Smax)), t( (MTcosts)), type = "l", lty=1, lwd=2,   xlab=" (Mass (kg))", ylab=" (Metabolic rate) in J/season", col=c(4, 3, "orange", 2))  ##this version of the plot confirms the metabolic costs are on teh same scale as those in Fig. 1 of Clarke and POrtner 2010.  #
  #lines(Income)
MTcosts[1, 2]
coef2<- 2e+18
for (S in (1:Smax)) {#
	for(p in 1:(3)) {#
		        S_g <- S #
		        MTcosts[p, S] <-  coef2*S_g^theta*exp(-E/(k*Temp[p]))   #
    }#
  }
matplot( ((1:Smax)), t( (MTcosts)), type = "l", lty=1, lwd=2,   xlab=" (Mass (kg))", ylab=" (Metabolic rate) in J/season", col=c(4, 3, "orange", 2))  ##this version of the plot confirms the metabolic costs are on teh same scale as those in Fig. 1 of Clarke and POrtner 2010.  #
  #lines(Income)
MTcosts[1, 2]
coef2<- 2e+19
for (S in (1:Smax)) {#
	for(p in 1:(3)) {#
		        S_g <- S #
		        MTcosts[p, S] <-  coef2*S_g^theta*exp(-E/(k*Temp[p]))   #
    }#
  }
matplot( ((1:Smax)), t( (MTcosts)), type = "l", lty=1, lwd=2,   xlab=" (Mass (kg))", ylab=" (Metabolic rate) in J/season", col=c(4, 3, "orange", 2))  ##this version of the plot confirms the metabolic costs are on teh same scale as those in Fig. 1 of Clarke and POrtner 2010.  #
  #lines(Income)
MTcosts[1, 2]
coef2<- 1e+19
for (S in (1:Smax)) {#
	for(p in 1:(3)) {#
		        S_g <- S #
		        MTcosts[p, S] <-  coef2*S_g^theta*exp(-E/(k*Temp[p]))   #
    }#
  }
matplot( ((1:Smax)), t( (MTcosts)), type = "l", lty=1, lwd=2,   xlab=" (Mass (kg))", ylab=" (Metabolic rate) in J/season", col=c(4, 3, "orange", 2))  ##this version of the plot confirms the metabolic costs are on teh same scale as those in Fig. 1 of Clarke and POrtner 2010.  #
  #lines(Income)
MTcosts[1, 1]
scale
?dnorm
read.csv("~/Documents/species_names.csv")
library(rfishbase)
species_list <- read.csv("~/Documents/species_names.csv")
maturity(species_list)
maturity(species_list[1:5])
species_list[1:5]
maturity(species_list[1:5,1])
maturity(species_list[1:15,1])
maturity(species_list[-38,1])
maturity(species_list[1:37,1])
maturity(species_list[1:30,1])
maturity(species_list[1:20,1])
read.csv("~/Documents/species_names.csv")
is.character(species_names)
as.character(species_names)
maturity(species_list[1:5,1])
data<- maturity(species_list[1:5,1])
data
View(data)
data<- maturity(species_list[1:25,1])
data
View(data)
data<- maturity(species_list[1:30,1])
head(data)
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=50#
#
    Amax=32 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.8 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.087#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# AGE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(a-amat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 0.5  #mobulid fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pmat*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for A > 2") #
barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  P_= 1:N0#
#
  R=alpha*P_/(1+beta*P_)#
#
   plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=50#
#
    Amax=32 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.8 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.087#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 0.5  #mobulid fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pmat*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for A > 2") #
barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  P_= 1:N0#
#
  R=alpha*P_/(1+beta*P_)#
#
   plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=50#
#
    Amax=32 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.8 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.087#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 12.5  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pmat*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for A > 2") #
barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  P_= 1:N0#
#
  R=alpha*P_/(1+beta*P_)#
#
   plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
pmat
Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size
recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.8 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 12.5  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop
pmat
plot(pmat)
pmat*pups
plot(pmat*pups)
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.8 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 40*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for A > 2") #
barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  P_= 1:N0#
#
  R=alpha*P_/(1+beta*P_)#
#
   plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 40*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for A > 2") #
barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  P_= 1:N0#
#
  R=alpha*P_/(1+beta*P_)#
#
   plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for L > 180 cm") #
# # barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
# barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
# #  par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# # plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    legend("bottomright", legend=c(paste("Length 50% mature ", Lmat)))#
# #    #
#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
# #  par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)), bty="n")#
# # plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
    legend("topleft", legend=c(paste("Length 50% mature ", Lmat)), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for L > 180 cm") #
# # barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
# barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
# #  par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)), bty="n")#
# # plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
    legend("topleft", legend=c(paste("Length 50% mature =", Lmat, " cm")), bty="n")#
# #    #
#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 180 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for L > 180 cm") #
# # barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
# barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
# #  par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)), bty="n")#
# # plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
    legend("topleft", legend=c(paste("Length 50% mature =", Lmat, " cm")), bty="n")#
# #    #
#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 120 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
barplot(steadystate, names.arg=c(1:Amax ), main="Unfished Age Structure", ylab="Abundance" )#
#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, main="Constant selectivity for L > 180 cm") #
# # barplot(log(steadystate), names.arg=c(1:Amax), ylab="Ln(Abundance)", xlab="Age")#
#
# barplot(log(fishedsteady), names.arg=c(1:Amax), col=1, xlab="Age") #
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))#
# #  par(mfrow=c(2,2))#
#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# # plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
    legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# #    #
#
  # P_= 1:N0#
#
  # R=alpha*P_/(1+beta*P_)#
#
   # plot(P_, R, type="l", main="Beverton Holt Recruitment", xlab="Female progeny[t]", ylab="Recruits[t+1]")#
#
    # legend("bottomright", legend=c(paste("alpha = ", round(alpha,6)), paste("beta = ", round(beta, 6))))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.2 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
    legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ),   ylim=c(0, N0), main="Unfished Age Structure", ylab="Abundance" )#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yxt="n", ylim=c(0, N0),  main="Constant selectivity for L > 180 cm") #
#
legend("topleft", legend=c(paste("Knife-edge selectivity for females >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bert growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ),   ylim=c(0, N0), main="Unfished age structure", ylab="Abundance" )#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ),   ylim=c(0, N0), main="Unfished age structure", ylab="Abundance" )#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm")
barplot(steadystate, names.arg=c(1:Amax ), yxt="n",  ylim=c(0, N0), main="Unfished age structure", ylab="Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000)#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm")
barplot(steadystate, names.arg=c(1:Amax ), yxt="n",  ylim=c(0, N0), main="Unfished age structure", ylab="Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm")
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  ylim=c(0, N0), main="Unfished age structure", ylab="Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yaxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm")
quartz()#
#
par(mfrow=c(2, 2),  las=1)
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  ylim=c(0, N0), main="Unfished age structure", ylab="Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yaxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm")
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), col=1, yaxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)" col=1, yaxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))
legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ))
quartz()#
#
par(mfrow=c(2, 2),  las=1)
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Knife-edged selectivity for L > 150 cm") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ), bty="n")
legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ), paste"Knife-edged selectivity for L > ", fishingsize, bty="n")
legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ), paste("Knife-edged selectivity for L > ", fishingsize), bty="n")
quartz()#
#
par(mfrow=c(2, 2),  las=1)
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ), paste("Knife-edged selectivity for L > ", fishingsize), bty="n")
legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ), paste("Knife-edged selectivity for L > ", fishingsize), bty="n")
legend("topright", legend=c(paste("Fishing mortality F =", mu_f) ), paste("Selectivity for L > ", fishingsize), bty="n")
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L > ", fishingsize), bty="n"))
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L > ", fishingsize, "cm")), bty="n")
quartz()#
#
par(mfrow=c(2, 2),  las=1)
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L > ", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1 #fishing mortality#
#
     natmort=0.1#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
barplot(fishedsteady, names.arg=c(1:Amax), xlab="Age (y)", col=1, yaxt="n", ylim=c(0, N0),  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
fastG<- fishedsteady
?barplot
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(gray80,1), yaxt="n", ylim=c(0, N0)) #,  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(gray(8),1), yaxt="n", ylim=c(0, N0)) #,  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(gray(0.8),1), yaxt="n", ylim=c(0, N0)) #,  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Fished age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", legend=c(paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(4, 4, NA, NA), col=c(1, gray(0.8) ), legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(3, 3, NA, NA), col=c(1, gray(0.8) ), legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(2, 2, NA, NA), col=c(1, gray(0.8) ), legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:15, 1:15, pch=c(1, 15))
barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, gray(0.8) ), cex=1.25, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, gray(0.8) ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, gray(0.8) ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, gray(0.9) ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.8) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, 2 ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, gray(0.9) ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, 2 ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, 2 ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, 2 ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Selectivity for L >", fishingsize, "cm")), bty="n")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(steadystate, fishedsteady), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, 2 ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, 2 ), cex=1, legend=c("Unfished","Fished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
quartz()#
#
par(mfrow=c(2, 2),  las=1)
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")
fishedsteady
length(fishedsteady)
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, 2 ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, 4 ), cex=1, legend=c(,"Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.07   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, 4 ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, 4 ), cex=1, legend=c(,"Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, "aqua" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, "aqua" ), cex=1, legend=c(,"Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c(1, "cyan" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c(1, "cyan" ), cex=1, legend=c(,"Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c("black", "cyan" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan" ), cex=1, legend=c(,"Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:Amax), xlab="Age (y)", col=c("black", "cyan" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=300 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.07   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 250)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure")
axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=320 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.25  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=350 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=280 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.08  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15#
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=350 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=280 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.08  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.1 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=35 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=280 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.1  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.1 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=35 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=280 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.05  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.1 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=35 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=250 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.05  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.1 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=220 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=300 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.1 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=220 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=300 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.08 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 20*pmat[a]  #hamemrhead fecundity is on average 1 female per year#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
Amax
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")
# axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32", "Amax = 40",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")
plot(1:Amax, L, type="l", main="von Bertalanffy growth", ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 # plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l",   ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 # plot(1:(Amax-1), pups[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female pups", xlab= "Age")#
#
   # # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
# # barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
mu
natmort
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .6  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 # barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  # axis(2, labels=c(0,1 ), at= c(0,20000))#
  # legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .7  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.15 #fishing mortality#
#
     natmort=0.15 #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 # barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  # axis(2, labels=c(0,1 ), at= c(0,20000))#
  # legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .7  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  axis(2, labels=c(0,1 ), at= c(0,20000))#
  # legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(0,Amax ), at= c(0,Amax))#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(steadystate, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=233 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.09  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
axis(1, labels=c(0,Amax ), at= seq(0,Amax))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(0,Amax ), at= seq(0,Amax))#
#
   # legend("topleft", legend=c(paste("Length 50% mature =", Lmat, "cm")), bty="n")#
barplot(rbind(steadystate, fishedsteady), names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
# #   barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#
  # axis(2, labels=c(0,1 ), at= c(0,20000))#
  # # legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
N0
fishedsteady
steadystate
barplot(rbind(steadystate, fishedsteady), names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
barplot(steadystate)
barplot(steadystate, ylim=c(0, 20000))
barplot(rbind(steadystate, fishedsteady), names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, 20000), main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
barplot(rbind(steadystate, fishedsteady), names.arg=c(1:Amax ),   xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
barplot(rbind(steadystate, fishedsteady)), names.arg=c(1:Amax ),   xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, names.arg=c(1:Amax ),   xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Unfished age structure", ylab="Relative Abundance" )
dim(steadystate)
dim(mat1)
mat2
mat1
matplot(t(mat1))
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, beside=T, names.arg=c(1:Amax ),   xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Unfished age structure", ylab="Relative Abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(1,2),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 legend("topright",   legend=c( paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(4,1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 legend("topright",   legend=c( paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(50),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 legend("topright",   legend=c( paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 legend("topright",   legend=c( paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
mat1<- rbind(steadystate, fishedsteady)#
barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
 legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
fastG<- fishedsteady
quartz()#
#
 par(mfrow=c(2,2))
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310)) #growth curve#
axis(1, labels=c(1,Amax ), at= seq(0,Amax))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))
plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(1,Amax ), at= seq(0,Amax-1))
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main=von Bertalanffy Growth) #growth curve#
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(1,Amax ), at= seq(0,Amax-1))
quartz()#
#
 par(mfrow=c(2,2))
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main=# von Bertalanffy Growth) #growth curve#
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(1,Amax ), at= seq(0,Amax-1))
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(1,Amax ), at= seq(0,Amax-1))
par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=c(1,Amax ), at= seq(0,Amax-1))
plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))
quartz()#
#
 par(mfrow=c(2,2))#
#
   # plot(1:Amax, L, type="l", main="von Bert growth", ylab="Disc Width (cm)", xlab="Age", ylim=c(0, 300)) #growth curve#
#
    # legend("bottomright", legend=c( paste("Linf = ", Linf), paste("von Bert k = ", k)))#
# plot(1:(Amax-1), pmat[-Amax], type="l", main="Maturation ogive", ylab = "Probability Mature", xlab="Age")#
#
 # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
#
 # plot(1:(Amax-1), pups[-Amax]*pmat[-Amax], type="l", main="Age-specific Fecundity", ylab="Number of female progeny", xlab= "Age")#
#
    # legend("bottomright", legend=c(paste("50% mature at age", amat)))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax ), at= seq(0,Amax-1))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
 plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
   # legend("topl
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=300 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.07  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",xaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=300 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",xaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",xaxt="n", ylim=c(0, N0)) #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0)) #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))
axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=325 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
quartz()#
#
par(mfrow=c(2, 2),  las=1)#
# ######Plot life history functions and population dynamics #
#
 quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0)) #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0)) #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=280 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics #
#
 quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0)) #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0)) #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #max age#
#
 	Lmat=200 #age at maturation - this varies depending on the matration function chosen#
#
	Linf=280 #max size#
#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.06  # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=.1 #maturation ogive steepness (1 = very steep)#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
    #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = 10*pmat[a]  #hamemrhead fecundity is on average 10 female per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics #
#
 quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #  plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 barplot(rbind(fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, NA, NA), col=c("black", "cyan3" ), cex=1, legend=c("Amax = 32, Lmat = 200", "Amax = 40, Lmat = 225",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf= 233 #280 # #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
       k=.0.09 # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]
quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
   plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
 axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=32 #max age#
#
 	Lmat=200 #225 #age at maturation - this varies depending on the matration function chosen#
#
	Linf= 233 #280 # #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
       k= 0.09 # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics #
#
 quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
   plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
 axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))
fastG<-fishedsteady
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
#
    Amax=40 #32 #max age#
#
 	Lmat=225 #200  #age at maturation - this varies depending on the matration function chosen#
#
	Linf= 280 #233  #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
       k= 0.06 #0.09 # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]
points(pups[1:31], pch=19, col="cyan3")
pups
points(pups[1:31], pch=19,cex=1.5, col="cyan3")
barplot(rbind(steadystate[1:32], fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("gray(0.5)", "black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, 15, NA, NA), col=c("gray(0.5)","black", "cyan3" ), cex=1, legend=c("Unfished", "Faster growth", "Slower growth",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
quartz()#
#
 par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #    plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
 # axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# points(pups[1:31], pch=19,cex=1.5, col="cyan3")#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 #fastG<-fishedsteady#
 barplot(rbind(steadystate[1:32], fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c("gray(0.5)", "black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3))#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, 15, NA, NA), col=c(gray(0.5),"black", "cyan3" ), cex=1, legend=c("Unfished", "Faster growth", "Slower growth",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2 main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #    plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
 # axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# points(pups[1:31], pch=19,cex=1.5, col="cyan3")#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 #fastG<-fishedsteady#
 barplot(rbind(steadystate[1:32], fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c(gray(0.5), "black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3)3)#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, 15, NA, NA), col=c(gray(0.5),"black", "cyan3" ), cex=1, legend=c("Unfished", "Faster growth", "Slower growth",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2 main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #    plot(1:(Amax-1),
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")#
# #    plot(1:(Amax-1), pups[-Amax], xaxt="n",  type="l", main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
 # axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
# points(pups[1:31], pch=19,cex=1.5, col="cyan3")#
# # mat1<- rbind(steadystate, fishedsteady)#
# barplot(mat1, beside=T, names.arg=c(1:Amax ), col=c(gray(.5),1),  xlab="Age (y)", ylim=c(0, 20000), yaxt="n", main="Age structure", ylab="Index of abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 # legend("topright", pch=c(15, 15, NA), col=c(gray(.5),1),  legend=c("Unfished",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")#
# #  #
  # barplot(fishedsteady, names.arg=c(1:Amax ), yaxt="n",  xlab="Age (y)", ylim=c(0, N0), main="Fished age structure", ylab="Relative Abundance" )#
 # axis(2, labels=c(0,1 ), at= c(0,20000))#
 #fastG<-fishedsteady#
 barplot(rbind(steadystate[1:32], fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c(gray(0.5), "black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3)3)#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, 15, NA, NA), col=c(gray(0.5),"black", "cyan3" ), cex=1, legend=c("Unfished", "Faster growth", "Slower growth",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
	Amax=32 #max age#
    #Amax=40  #
	Lmat=200#
 	#Lmat=225    #age at maturation - this varies depending on the matration function chosen#
	 Linf=233#
	#Linf= 280    #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
		k=0.09#
       # k= 0.06   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310),  lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
unfished=steadystate
fastG=fishedsteady
fastpup = pups
fastput
fastpup
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
	# Amax=32 #max age#
     Amax=40  #
	# Lmat=200#
 	Lmat=225    #age at maturation - this varies depending on the matration function chosen#
	 # Linf=233#
	 Linf= 280    #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
		# k=0.09#
        k= 0.06   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
fastput
fastpup
plot(1:(Amax-1), fastpup[-Amax], xaxt="n",  type="p", cex=1.25, main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
  axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
 points(pups[1:31], pch=19,cex=1.25, col="cyan3")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
slowpup=pups
slowG=fishedsteady
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
	 Amax=32 #max age#
     # Amax=40  #
	 Lmat=200#
 	# Lmat=225    #age at maturation - this varies depending on the matration function chosen#
	 Linf=233#
	 # Linf= 280    #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
		 k=0.09#
        # k= 0.06   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310),  lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
##Author: Holly K. Kindsvater, 2019#
#
##age structured model for Sphyrna lewini populaiton dynamics and demography with varying selectivity.     #
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
	 #Amax=32 #max age#
     Amax=40  #
	 #Lmat=200#
   Lmat=225    #age at maturation - this varies depending on the matration function chosen#
	 #Linf=233#
	 Linf= 280    #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
		 #k=0.09#
         k= 0.06   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
   plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
pups
fastpup
slowpup
plot(1:(Amax-1), fastpup[-Amax], xaxt="n",  type="p", cex=1.25, main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
  axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
 points(slowpup[1:31], pch=19,cex=1.25, col="cyan3")
plot(1:(Amax-1), fastpup[1:31], xaxt="n",  type="p", cex=1.25, main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
  axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
 points(slowpup[1:31], pch=19,cex=1.25, col="cyan3")
length(fastpup)
fastput
Amaz
Amax
L
slowL=L
#Model parameters:#
#
Npop=100  #initial pop size (not important)#
#
Tmax=500 #max years#
#
Tfishing=200 #start fishing#
#
Trecovery=400 #stop fishing #
    #Life history parameters      	#
#
   recruitsize=100#
	 Amax=32 #max age#
     #Amax=40  #
	 Lmat=200#
   #Lmat=225    #age at maturation - this varies depending on the matration function chosen#
	 Linf=233#
	 #Linf= 280    #max size#
	 fishingsize = 150 #size-selective fishery threshold size #
		  k=0.09#
         #k= 0.06   # Growth function param	 	 #
#
	   v=0.00002  #mass-at-size coef#
#
	    wexp = 3  #mass-at-size exp#
#
	    h=1 #sperm fertilization effectiveness#
#
 	    N0 = 20000       #
#
  	    alpha = .8  	#
#
  	    q=0.1 #maturation ogive steepness (1 = very steep)#
#
		female_offspring = 10#
   mu_f=0.1  #fishing mortality#
#
     natmort=0.1  #
#
     #set up vectors and matrices#
#
pmat=rep(0, Amax) #
#
select=rep(0, Amax)#
#
pups=rep(0, Amax)#
#
mu=rep(0, Amax)#
#
N=matrix(nrow=Amax, ncol=Tmax, data=0)#
W=matrix(nrow=Amax, ncol=1, data=1)#
#
L=matrix(nrow=Amax, ncol=1, data=1)#
#
mu=matrix(nrow=Amax, ncol=1, data=0)#
#
E=matrix(nrow=Amax, ncol=Tmax, data=0)#
#
S=matrix(nrow=1, ncol=Tmax, data=0)#
#
P=matrix(nrow=1, ncol=Tmax)#
#
B=matrix(nrow=1, ncol=Tmax)#
 N[, 1]=Npop #initial population size#
#
L[1]=recruitsize #larval size at recruitment (birth)#
#First: Define the age-specific growth, mortality, and maturation function#
  	for (a in 1:(Amax-1)) {#
	#GROWTH 		 #
#
	L[a+1]= Linf*(1-exp(-k)) + (L[a])*exp(-k) #length at age#
#
     W[a]= v*L[a]^wexp #weight at age#
	# SIZE-DEP MATURATION:#
#
       pmat[a]= 1/(1+exp(-q*(L[a]-Lmat))) #
 	#FISHING SELECTIVITY # knife edge after 1 meter#
#
      select[a] = ifelse(L[a+1] < fishingsize, 0, 1)     #
 	#FECUNDITY#
#
       pups[a] = female_offspring*pmat[a]  #hamemrhead fecundity is max 10 females per year (40 total over two years, including males)#
    #MORTALITY#
#
       mu[a] = natmort #could vary with age but assumed constant here#
   } #end 1st age loop#
 #With these age specific functions, simulate pop dynamics through time       #
#
 for(t in 1:(Tmax-1)) {#
	E[,t]=N[, t]*pups  #assuming reproduction occurs between 1 t and the next#
	P[t]= sum(E[,t])  #assuming fertilization is 100%, this is the year class of progeny produced in year t#
  	beta= (alpha*P[t]-1)/(N0*P[t])  #derive the recruitment function from the slope near the origin#
 	N[1,t+1]= alpha*P[t]/(1+beta*P[t]) #this is the recruit class that enters in the next time step.. #
     for (age in 1:(Amax-1)) { #now calculate age-specific probability of fishing mortality#
   Fishing= if (Tfishing < t & Trecovery > t) {#
#
   				Fishing = select[age]*mu_f } else {#
#
   				Fishing = 0#
#
                     }#
 		N[age+1,t+1] = N[age, t]*exp(-mu[age]-Fishing) #numbers in each age class in the next time step #
#
 		#assuming mortality happens after spawning#
 		B[t]=sum(N[,t]*W) #biomass#
   		 } #end second age loop#
       } #end t loop#
 steadystate=N[,Tmax]#
#
 fishedsteady=N[ ,Trecovery -2]#
# ######Plot life history functions and population dynamics #
#
 # quartz()#
#
 # par(mfrow=c(2,2))#
  plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
# axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
    # legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
plot(1:Amax, L, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310),  lwd=2, main= "von Bertalanffy Growth") #growth curve#
  axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,Amax-1, by = 3))#
#
     legend("bottomright", legend=c( paste("Linf =", Linf), paste("von Bert k =", k)), bty="n")
plot(1:40, slowL, type="l", xaxt="n",  ylab="Length (cm)", xlab="Age (y)", ylim=c(0, 310), col="cyan3", lwd=2, main= "von Bertalanffy Growth") #growth curve#
  axis(1, labels=seq(1,40, by=3 ), at= seq(0,39, by = 3))#
#
     legend("bottomright", legend=c( paste("Linf =", 280), paste("von Bert k =",0.06)), bty="n")
plot(1:(31), fastpup[1:31], xaxt="n",  type="p", cex=1.25, main="Age-specific Fecundity", ylab="Annual number of female pups", xlab= "Age")#
  axis(1, labels=seq(1,Amax, by=3 ), at= seq(0,31, by = 3))#
 points(slowpup[1:31], pch=19,cex=1.25, col="cyan3")
points(fastpup[1:31], pch=19,cex=1.25, col=1)
barplot(rbind(steadystate[1:32], fastG, fishedsteady[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c(gray(0.5), "black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3)3)#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, 15, NA, NA), col=c(gray(0.5),"black", "cyan3" ), cex=1, legend=c("Unfished", "Faster growth", "Slower growth",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
slowG
barplot(rbind(steadystate[1:32], fastG, slowG[1:32]), beside=T, names.arg=c(1:32), xlab="Age (y)", col=c(gray(0.5), "black", "cyan3" ), yaxt="n",  ylim=c(0, N0), ylab="Index of abundance") #,  main="Age structure") #
#axis(1, labels=seq(1,32, by=3 ), at= seq(0,31, by = 3)3)#
#
 axis(2, labels=c(0,1 ), at= c(0,20000))#
  legend("topright", pch=c(15, 15, 15, NA, NA), col=c(gray(0.5),"black", "cyan3" ), cex=1, legend=c("Unfished", "Faster growth", "Slower growth",  paste("Fishing mortality F =", mu_f) , paste("Constant selectivity for L >", fishingsize, "cm")), bty="n")
citation
citation()
0.0005*100^3
setwd("~/Documents/tuna_theory/seasonal")#
data_files <- list.files(pattern = "\\.csv$")#
#
repro_filenames <- data_files[((length(data_files)/4)+1):(2*(length(data_files)/4))]   #
state_filenames <- data_files[(2*(length(data_files)/4)+1):(3*(length(data_files)/4))]#
length_filenames <- data_files[1:(length(data_files)/4)]#
surv_filenames <- data_files[(3*(length(data_files)/4)+1):(4*(length(data_files)/4))]#
#
length_filenames <- unique(length_filenames)#
repro_filenames <- unique(repro_filenames)#
state_filenames <- unique(state_filenames)#
surv_filenames <- unique(surv_filenames)#
#
length_data <- lapply(length_filenames, read.csv)#
repro_data <- lapply(repro_filenames, read.csv)#
state_data <- lapply(state_filenames, read.csv)#
surv_data <- lapply(surv_filenames, read.csv)#
 time=1:192#
  quartz()#
   par(mfrow=c(2,1))#
plot_length <- function(data, filenames) {#
     matplot(t(data[,-1]), type="l", main=substr(filenames, 9, 30), col="darkgray", lwd=1.75, lty=1,  ylab="Length (cm)", ylim=c(0, 400), xlim=c(0.5, 164), xlab= "Age (years)", xaxt="n")#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1)))#
     maxsize <- (min(which(as.numeric(data[1, -1]) == max(as.numeric(data[1, -1]))))) + 1 #
     age_m <- min(which(as.numeric(data[1, -1]) >= 0.5*as.numeric(data[1, maxsize])))/4 #
     #legend("topright", legend=paste0("A_50 is ", age_m+1, " years"), bty="n")#
          }#
 mapply(plot_length, length_data, length_filenames)
quartz()#
   par(mfrow=c(2,1))#
plot_length <- function(data, filenames) {#
     matplot(t(data[,-1]), type="l", main=substr(filenames, 9, 30), col="darkgray", lwd=1.75, lty=1,  ylab="Length (cm)", ylim=c(0, 600), xlim=c(0.5, 164), xlab= "Age (years)", xaxt="n")#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1)))#
     maxsize <- (min(which(as.numeric(data[1, -1]) == max(as.numeric(data[1, -1]))))) + 1 #
     age_m <- min(which(as.numeric(data[1, -1]) >= 0.5*as.numeric(data[1, maxsize])))/4 #
     #legend("topright", legend=paste0("A_50 is ", age_m+1, " years"), bty="n")#
          }#
 mapply(plot_length, length_data, length_filenames)
quartz()#
   par(mfrow=c(2,1))#
plot_length <- function(data, filenames) {#
     matplot(t(data[,-1]), type="l", main=substr(filenames, 9, 30), col="darkgray", lwd=1.75, lty=1,  ylab="Length (cm)", ylim=c(0, 1000), xlim=c(0.5, 164), xlab= "Age (years)", xaxt="n")#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1)))#
     maxsize <- (min(which(as.numeric(data[1, -1]) == max(as.numeric(data[1, -1]))))) + 1 #
     age_m <- min(which(as.numeric(data[1, -1]) >= 0.5*as.numeric(data[1, maxsize])))/4 #
     #legend("topright", legend=paste0("A_50 is ", age_m+1, " years"), bty="n")#
          }#
 mapply(plot_length, length_data, length_filenames)
quartz()#
   par(mfrow=c(2,1))#
plot_length <- function(data, filenames) {#
     matplot(t(data[,-1]), type="l", main=substr(filenames, 9, 30), col="darkgray", lwd=1.75, lty=1,  ylab="Length (cm)", ylim=c(0, 2000), xlim=c(0.5, 164), xlab= "Age (years)", xaxt="n")#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1)))#
     maxsize <- (min(which(as.numeric(data[1, -1]) == max(as.numeric(data[1, -1]))))) + 1 #
     age_m <- min(which(as.numeric(data[1, -1]) >= 0.5*as.numeric(data[1, maxsize])))/4 #
     #legend("topright", legend=paste0("A_50 is ", age_m+1, " years"), bty="n")#
          }#
 mapply(plot_length, length_data, length_filenames)
plot_repro <- function(repro_data, repro_filenames) {#
     matplot(t(repro_data[,-1]), type="l", main= substr(repro_filenames, 8, 20), col="darkgray", lwd=1.75, lty=1,   ylab="Reproduction (J)",   xlab= "Age (years)", xaxt="n", ylim=c(0, 1e+09), xlim=c(0.5, 48))#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1)))#
    print(repro_data[,-1]) #
     }#
#
mapply(plot_repro, repro_data, repro_filenames)
# par(mfrow=c(3, 3))#
 age.length <- function(ldata1, rdata2, filenames) {#
 	data1 <- as.numeric(ldata1[1,])#
 	data2 <- as.numeric(rdata2[1, ])#
 	#need to make a log log plot#
 	matplot(t(log(data1[c(-1,-195)])), t(log(data2[c(-1,-195)])), type="p", col="darkgray", pch=20,   main= substr(filenames, 9, 30),  xlab="ln(Length) ", ylim=c(0, 25), xlim=c(0, 6), ylab="ln(Reproduction) ")#
 	# print((ldata1))#
 	# print((rdata2))#
 	m1<-lm(log(data2[c(-1,-193)])~log(data1[c(-1,-193)]))#
 	if(is.na(coef(m1)[2])==FALSE)  	abline(m1)#
 	#val<-paste0("Env is ", substr(filenames, 9, 23),", Slope is ", round(as.numeric(coef(m1)[2]), 3))#
   legend("topleft",   legend=paste0("slope is ",round(as.numeric(coef(m1)[2]), 3)), bty="n")#
 	   	} #
mapply(age.length, length_data, repro_data, length_filenames)#
# quartz()#
 # par(mfrow=c(2,2))#
#
 surv <- function(data, filenames) {#
 	matplot(data[,-1], type="l", main= substr(filenames, 6, 25), col="darkgray", xlab="Age (years)", ylab="Survival", xaxt="n", ylim=c(0, 1.1), xlim=c(0.5, 164))#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1)))#
 }#
 	mapply(surv, surv_data, surv_filenames)#
    lnsurv <- function(data, filenames) {#
 	data1<-as.numeric(data[,2])#
 	matplot(log(data1[-1]), type="l", main= substr(filenames, 7, 30), col="darkgray", xlab="Age (years)", ylab="ln(Survival)", xaxt="n",  ylim=c(-10, 0), xlim=c(0.5, 164))#
     axis(1, at = seq(0, 192, by=12), labels = (seq(1, 17, by=1))) #
   m2<-lm(log(data1[-1])~time[-192])#
   abline(m2)#
   #print(paste0("Env is ", substr(surv_filenames, 8, 18))),", Slope is ", round(as.numeric(coef(m2)[2]), 3)))#
   legend("bottomleft",   legend=paste0("slope is ",round(as.numeric(coef(m2)[2]), 3)), bty="n")#
 }#
 	mapply(lnsurv, surv_data, surv_filenames)
